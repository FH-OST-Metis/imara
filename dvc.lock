schema: '2.0'
stages:
  extract:
    cmd: uv run python src/app/extract.py --input data/raw/documents --output 
      data/processed/extracted
    deps:
    - path: data/raw/documents
      hash: md5
      md5: b99cf919d7316a6142a381d38dce66a6.dir
      size: 3615190939
      nfiles: 1001
    - path: src/app/extract.py
      hash: md5
      md5: ad4d553b94723e18e22baeb9bdea90e1
      size: 15715
    params:
      params.yaml:
        extract.batch_size: 1
        extract.source_handling: copy
    outs:
    - path: data/processed/extracted
      hash: md5
      md5: 2fd66098f33b1fa4f54622de2ee7e74d.dir
      size: 131543751
      nfiles: 60
  embed:
    cmd: uv run python src/app/embed.py --input data/processed/chunks 
      --artifacts data/processed/extracted --database_url 
      postgresql://postgres:postgres@127.0.0.1:54322/postgres
    deps:
    - path: data/processed/chunks
      hash: md5
      md5: 97d328068fbd9307ce5e3db94b1beeb2.dir
      size: 159631484
      nfiles: 278692
    - path: data/processed/extracted
      hash: md5
      md5: 2b597a1b3021010b926d35600555ddc4.dir
      size: 27059869438
      nfiles: 12955
    - path: src/app/embed.py
      hash: md5
      md5: 7d8ab6ac7c1849135050a89d6ec03655
      size: 4048
  prep_pipeline:
    cmd: uv run python src/app/prep_pipeline.py
    deps:
    - path: src/app/prep_pipeline.py
      hash: md5
      md5: ddf23f4d5e8dcaf9ee687f32fd8ca071
      size: 1231
  graphmert_train:
    cmd: uv run python src/app/graphmert_train.py
    deps:
    - path: data/processed/chunks
      hash: md5
      md5: 97d328068fbd9307ce5e3db94b1beeb2.dir
      size: 159631484
      nfiles: 278692
    - path: src/app/graphmert_train.py
      hash: md5
      md5: 217026f724d33bea92e12e5f876af678
      size: 8961
    outs:
    - path: data/graphmert
      hash: md5
      md5: d449581375fd3369d52728f27e6be305.dir
      size: 15141258
      nfiles: 3
  graphmert_corpus:
    cmd: uv run python src/app/graphmert/corpus.py
    deps:
    - path: data/processed/chunks
      hash: md5
      md5: b3fd5b1369d991ccf8c917283af28719.dir
      size: 458580
      nfiles: 848
    - path: src/app/graphmert/corpus.py
      hash: md5
      md5: 165de504a23a3164d6440cf993123fda
      size: 1293
    outs:
    - path: data/graphmert/corpus
      hash: md5
      md5: 8b78db13f1b7ad6266f7f30c7783e553.dir
      size: 483984
      nfiles: 1
  graphmert_embeddings:
    cmd: uv run python src/app/graphmert/embeddings.py
    deps:
    - path: data/graphmert/corpus/corpus.json
      hash: md5
      md5: d700260840efb5a3eba64cda28da7677
      size: 483984
    - path: src/app/graphmert/embeddings.py
      hash: md5
      md5: 9e52ac1df2a034f9e7d917db923a9b91
      size: 2694
    outs:
    - path: data/graphmert/embeddings
      hash: md5
      md5: 7df7392aaddd848b37b953b67d5474dc.dir
      size: 34048
      nfiles: 1
  graphmert_build_graphs:
    cmd: uv run python src/app/graphmert/build_graphs.py
    deps:
    - path: data/graphmert/embeddings/reduced_embeddings.npy
      hash: md5
      md5: cb5559bd9c9b8085619eba5f626dc8f8
      size: 34048
    - path: src/app/graphmert/build_graphs.py
      hash: md5
      md5: 0a4807da6b4a515a330bd47a7caac6fc
      size: 1569
    outs:
    - path: data/graphmert/graphs
      hash: md5
      md5: 730c3d7f1abc56b04138b007a48e8e1f.dir
      size: 280530
      nfiles: 1
  graphmert_train_model:
    cmd: uv run python src/app/graphmert/train_model.py
    deps:
    - path: data/graphmert/graphs/sentence_transformer_fixed10d_graphs.json
      hash: md5
      md5: e6072dc6a584f02c5c2a1149a203ac31
      size: 280530
    - path: src/app/graphmert/train_model.py
      hash: md5
      md5: 514a2be1ab2d6f34b4e027fcf4214b50
      size: 6114
    outs:
    - path: data/graphmert/model
      hash: md5
      md5: 0b1ea182d2979186ea22d40863b08bfa.dir
      size: 15126780
      nfiles: 2
  naiverag_chunk:
    cmd: uv run python src/app/naiverag/chunk.py --input 
      data/processed/extracted --output data/processed/chunks
    deps:
    - path: data/processed/extracted
      hash: md5
      md5: 2fd66098f33b1fa4f54622de2ee7e74d.dir
      size: 131543751
      nfiles: 60
    - path: src/app/naiverag/chunk.py
      hash: md5
      md5: f879183e47c88d6e7b788e3ba723828d
      size: 3696
    params:
      params.yaml:
        chunk.chunk_size: 500
        chunk.overlap: 100
        chunk.split_by: section
    outs:
    - path: data/processed/chunks
      hash: md5
      md5: b3fd5b1369d991ccf8c917283af28719.dir
      size: 458580
      nfiles: 848
  naiverag_embed:
    cmd: uv run python src/app/naiverag/embed.py --input data/processed/chunks 
      --artifacts data/processed/extracted --database_url 
      postgresql://postgres:postgres@127.0.0.1:54322/postgres
    deps:
    - path: data/processed/chunks
      hash: md5
      md5: b3fd5b1369d991ccf8c917283af28719.dir
      size: 458580
      nfiles: 848
    - path: data/processed/extracted
      hash: md5
      md5: 2fd66098f33b1fa4f54622de2ee7e74d.dir
      size: 131543751
      nfiles: 60
    - path: src/app/naiverag/embed.py
      hash: md5
      md5: d21b6d55f73e3d4d473473f060a76604
      size: 4213
  generate_queries:
    cmd: uv run open-rag-eval generate-queries --config query_gen_config.yaml
    deps:
    - path: data/processed/extracted
      hash: md5
      md5: 2fd66098f33b1fa4f54622de2ee7e74d.dir
      size: 131543751
      nfiles: 60
    - path: query_gen_config.yaml
      hash: md5
      md5: 10d40f6a857d3f69c7b91b4d122865cc
      size: 1390
    params:
      query_gen_config.yaml:
        generation.n_questions: 10
        generation.questions_per_doc: 10
        model.name: models/gemini-2.5-flash
        model.type: GeminiModel
    outs:
    - path: data/eval/queries.csv
      hash: md5
      md5: 56be9e8e14f5a755c9a50bc07f4e0cc7
      size: 4081
  graphmert_generate_answers:
    cmd: uv run python src/app/eval_open_rag.py --system graphmert --queries 
      data/eval/queries.csv --output data/eval/graphmert/generated_answers.csv
    deps:
    - path: data/eval/queries.csv
      hash: md5
      md5: 56be9e8e14f5a755c9a50bc07f4e0cc7
      size: 4081
    - path: data/processed/chunks
      hash: md5
      md5: b3fd5b1369d991ccf8c917283af28719.dir
      size: 458580
      nfiles: 848
    - path: src/app/eval_open_rag.py
      hash: md5
      md5: a96e27ee4f5c3c57237280dcc0b9db4a
      size: 20193
    - path: src/app/graphmert/corpus.py
      hash: md5
      md5: 165de504a23a3164d6440cf993123fda
      size: 1293
    - path: src/app/graphmert/inference.py
      hash: md5
      md5: cc5c00fd2f71f04ae9968d1f02e71697
      size: 7241
    - path: src/app/graphmert/train_model.py
      hash: md5
      md5: 514a2be1ab2d6f34b4e027fcf4214b50
      size: 6114
    - path: src/app/utils/params_helper.py
      hash: md5
      md5: 63ae89e1b9f548569371e1c50daa52b6
      size: 224
    params:
      params.yaml:
        eval.top_k: 5
    outs:
    - path: data/eval/graphmert/generated_answers.csv
      hash: md5
      md5: c4de34e8c1111827f6a83e3111499c65
      size: 37360
  naiverag_generate_answers:
    cmd: uv run python src/app/eval_open_rag.py --system naiverag --queries 
      data/eval/queries.csv --output data/eval/naiverag/generated_answers.csv
    deps:
    - path: data/eval/queries.csv
      hash: md5
      md5: 56be9e8e14f5a755c9a50bc07f4e0cc7
      size: 4081
    - path: data/processed/chunks
      hash: md5
      md5: b3fd5b1369d991ccf8c917283af28719.dir
      size: 458580
      nfiles: 848
    - path: src/app/embedder.py
      hash: md5
      md5: 67e5243b0780cf22eb5fa9d16f15c31d
      size: 4006
    - path: src/app/eval_open_rag.py
      hash: md5
      md5: a96e27ee4f5c3c57237280dcc0b9db4a
      size: 20193
    - path: src/app/utils/params_helper.py
      hash: md5
      md5: 63ae89e1b9f548569371e1c50daa52b6
      size: 224
    params:
      params.yaml:
        eval.top_k: 5
    outs:
    - path: data/eval/naiverag/generated_answers.csv
      hash: md5
      md5: 9cbd25251219c1a459e601e026156bc2
      size: 94682
  graphmert_eval:
    cmd: uv run open-rag-eval eval --config configs/open_rag_eval_graphmert.yaml
    deps:
    - path: configs/open_rag_eval_graphmert.yaml
      hash: md5
      md5: 5527b850c96e92ce580f364fdde0cead
      size: 866
    - path: data/eval/graphmert/generated_answers.csv
      hash: md5
      md5: c4de34e8c1111827f6a83e3111499c65
      size: 37360
    - path: data/eval/queries.csv
      hash: md5
      md5: 56be9e8e14f5a755c9a50bc07f4e0cc7
      size: 4081
    params:
      configs/open_rag_eval_graphmert.yaml:
        evaluator.0.model.name: gemini-2.5-flash
        evaluator.0.model.type: GeminiModel
        evaluator.0.options.k_values:
        - 1
        - 3
        - 5
    outs:
    - path: data/eval/graphmert/TRECEvaluator-metrics.png
      hash: md5
      md5: 89320c788a83f30f5d3c41fc491c7895
      size: 279914
    - path: data/eval/graphmert/results.csv
      hash: md5
      md5: cc12d85fbd0f93901ad54ec2ede2f786
      size: 40849
  naiverag_eval:
    cmd: uv run open-rag-eval eval --config configs/open_rag_eval_naiverag.yaml
    deps:
    - path: configs/open_rag_eval_naiverag.yaml
      hash: md5
      md5: f3d987e1ad138dde93a4f4dfa94a4ade
      size: 884
    - path: data/eval/naiverag/generated_answers.csv
      hash: md5
      md5: 9cbd25251219c1a459e601e026156bc2
      size: 94682
    - path: data/eval/queries.csv
      hash: md5
      md5: 56be9e8e14f5a755c9a50bc07f4e0cc7
      size: 4081
    params:
      configs/open_rag_eval_naiverag.yaml:
        evaluator.0.model.name: gemini-2.5-flash
        evaluator.0.model.type: GeminiModel
        evaluator.0.options.k_values:
        - 1
        - 3
        - 5
    outs:
    - path: data/eval/naiverag/TRECEvaluator-metrics.png
      hash: md5
      md5: ad5d2feed1834e93f85a6ceacf0b1153
      size: 279085
    - path: data/eval/naiverag/results.csv
      hash: md5
      md5: b9b471e22dfae5ff8dce4098551d3661
      size: 103784
  linearrag_generate_answers:
    cmd: uv run python src/app/eval_open_rag.py --system linearrag --queries 
      data/eval/queries.csv --output data/eval/linearrag/generated_answers.csv 
      --database_url postgresql://postgres:postgres@127.0.0.1:54322/postgres
    deps:
    - path: data/eval/queries.csv
      hash: md5
      md5: 56be9e8e14f5a755c9a50bc07f4e0cc7
      size: 4081
    - path: src/app/eval_open_rag.py
      hash: md5
      md5: a96e27ee4f5c3c57237280dcc0b9db4a
      size: 20193
    - path: src/app/linear_rag/retrieve.py
      hash: md5
      md5: 8e782964def7e849058dc53b9a7bf35b
      size: 34125
    - path: src/app/utils/params_helper.py
      hash: md5
      md5: 63ae89e1b9f548569371e1c50daa52b6
      size: 224
    params:
      params.yaml:
        eval.top_k: 5
        generation.max_tokens: 30000
        index.embedding_provider: ollama
        index.spacy_model: en_core_sci_md
        retrieval.retrieval_top_k: 5
    outs:
    - path: data/eval/linearrag/generated_answers.csv
      hash: md5
      md5: 4bcf3953e3f2933f51f16fd4e1f39a27
      size: 3166
  linearrag_index:
    cmd: uv run python src/app/linear_rag/index.py --database_url 
      postgresql://postgres:postgres@127.0.0.1:54322/postgres
    deps:
    - path: src/app/linear_rag/index.py
      hash: md5
      md5: 61521e36b7df712ae2d2a28b25b79c62
      size: 17601
    params:
      params.yaml:
        index.batch_size: 32
        index.spacy_model: en_core_sci_md
  linearrag_load:
    cmd: uv run python src/app/linear_rag/load.py --input data/processed/chunks 
      --artifacts data/processed/extracted --database_url 
      postgresql://postgres:postgres@127.0.0.1:54322/postgres
    deps:
    - path: data/processed/chunks
      hash: md5
      md5: b3fd5b1369d991ccf8c917283af28719.dir
      size: 458580
      nfiles: 848
    - path: data/processed/extracted
      hash: md5
      md5: 2fd66098f33b1fa4f54622de2ee7e74d.dir
      size: 131543751
      nfiles: 60
    - path: src/app/linear_rag/load.py
      hash: md5
      md5: 59d888a4a2df9a1f335496f4d9c54d68
      size: 6615
    params:
      params.yaml:
        load.batch_size: 100
  linearrag_eval:
    cmd: uv run open-rag-eval eval --config configs/open_rag_eval_linearrag.yaml
    deps:
    - path: configs/open_rag_eval_linearrag.yaml
      hash: md5
      md5: 2b95c230b240cb82bf07908ef99fd205
      size: 886
    - path: data/eval/linearrag/generated_answers.csv
      hash: md5
      md5: 4bcf3953e3f2933f51f16fd4e1f39a27
      size: 3166
    - path: data/eval/queries.csv
      hash: md5
      md5: 56be9e8e14f5a755c9a50bc07f4e0cc7
      size: 4081
    params:
      configs/open_rag_eval_linearrag.yaml:
        evaluator.0.model.name: gemini-2.5-flash
        evaluator.0.model.type: GeminiModel
        evaluator.0.options.k_values:
        - 1
        - 3
        - 5
    outs:
    - path: data/eval/linearrag/TRECEvaluator-metrics.png
      hash: md5
      md5: 47f466c22296c6d44e50950fe0280fcd
      size: 275584
    - path: data/eval/linearrag/results.csv
      hash: md5
      md5: d8f49821d7890b4f72f4eb8717c4f581
      size: 9792
