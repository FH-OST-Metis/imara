schema: '2.0'
stages:
  extract:
    cmd: uv run python src/app/extract.py --input data/raw/documents --output 
      data/processed/extracted
    deps:
    - path: data/raw/documents
      hash: md5
      md5: b99cf919d7316a6142a381d38dce66a6.dir
      size: 3615190939
      nfiles: 1001
    - path: src/app/extract.py
      hash: md5
      md5: ad4d553b94723e18e22baeb9bdea90e1
      size: 15715
    params:
      params.yaml:
        extract.batch_size: 1
        extract.source_handling: copy
    outs:
    - path: data/processed/extracted
      hash: md5
      md5: 2fd66098f33b1fa4f54622de2ee7e74d.dir
      size: 131543751
      nfiles: 60
  embed:
    cmd: uv run python src/app/embed.py --input data/processed/chunks 
      --artifacts data/processed/extracted --database_url 
      postgresql://postgres:postgres@127.0.0.1:54322/postgres
    deps:
    - path: data/processed/chunks
      hash: md5
      md5: 97d328068fbd9307ce5e3db94b1beeb2.dir
      size: 159631484
      nfiles: 278692
    - path: data/processed/extracted
      hash: md5
      md5: 2b597a1b3021010b926d35600555ddc4.dir
      size: 27059869438
      nfiles: 12955
    - path: src/app/embed.py
      hash: md5
      md5: 7d8ab6ac7c1849135050a89d6ec03655
      size: 4048
  prep_pipeline:
    cmd: uv run python src/app/prep_pipeline.py
    deps:
    - path: src/app/prep_pipeline.py
      hash: md5
      md5: ddf23f4d5e8dcaf9ee687f32fd8ca071
      size: 1231
  graphmert_train:
    cmd: uv run python src/app/graphmert_train.py
    deps:
    - path: data/processed/chunks
      hash: md5
      md5: 97d328068fbd9307ce5e3db94b1beeb2.dir
      size: 159631484
      nfiles: 278692
    - path: src/app/graphmert_train.py
      hash: md5
      md5: 217026f724d33bea92e12e5f876af678
      size: 8961
    outs:
    - path: data/graphmert
      hash: md5
      md5: d449581375fd3369d52728f27e6be305.dir
      size: 15141258
      nfiles: 3
  graphmert_corpus:
    cmd: uv run python src/app/graphmert/corpus.py
    deps:
    - path: data/processed/chunks
      hash: md5
      md5: b3fd5b1369d991ccf8c917283af28719.dir
      size: 458580
      nfiles: 848
    - path: src/app/graphmert/corpus.py
      hash: md5
      md5: 165de504a23a3164d6440cf993123fda
      size: 1293
    outs:
    - path: data/graphmert/corpus
      hash: md5
      md5: 8b78db13f1b7ad6266f7f30c7783e553.dir
      size: 483984
      nfiles: 1
  graphmert_embeddings:
    cmd: uv run python src/app/graphmert/embeddings.py
    deps:
    - path: data/graphmert/corpus/corpus.json
      hash: md5
      md5: d700260840efb5a3eba64cda28da7677
      size: 483984
    - path: src/app/graphmert/embeddings.py
      hash: md5
      md5: 9e52ac1df2a034f9e7d917db923a9b91
      size: 2694
    outs:
    - path: data/graphmert/embeddings
      hash: md5
      md5: 52d5c09dd229e75d0600897f0208ab65.dir
      size: 34048
      nfiles: 1
  graphmert_build_graphs:
    cmd: uv run python src/app/graphmert/build_graphs.py
    deps:
    - path: data/graphmert/embeddings/reduced_embeddings.npy
      hash: md5
      md5: b809135a902ae664e2502e2e5e58ed9d
      size: 34048
    - path: src/app/graphmert/build_graphs.py
      hash: md5
      md5: 0a4807da6b4a515a330bd47a7caac6fc
      size: 1569
    outs:
    - path: data/graphmert/graphs
      hash: md5
      md5: 3528a207f91767b983a9a861a680928d.dir
      size: 280620
      nfiles: 1
  graphmert_train_model:
    cmd: uv run python src/app/graphmert/train_model.py
    deps:
    - path: data/graphmert/graphs/sentence_transformer_fixed10d_graphs.json
      hash: md5
      md5: f9d91980ae000be621d68cf09566d989
      size: 280620
    - path: src/app/graphmert/train_model.py
      hash: md5
      md5: 514a2be1ab2d6f34b4e027fcf4214b50
      size: 6114
    outs:
    - path: data/graphmert/model
      hash: md5
      md5: f02127ae49c4685566c4f881f8f74c24.dir
      size: 15126780
      nfiles: 2
  naiverag_chunk:
    cmd: uv run python src/app/naiverag/chunk.py --input 
      data/processed/extracted --output data/processed/chunks
    deps:
    - path: data/processed/extracted
      hash: md5
      md5: 2fd66098f33b1fa4f54622de2ee7e74d.dir
      size: 131543751
      nfiles: 60
    - path: src/app/naiverag/chunk.py
      hash: md5
      md5: f879183e47c88d6e7b788e3ba723828d
      size: 3696
    params:
      params.yaml:
        chunk.chunk_size: 500
        chunk.overlap: 100
        chunk.split_by: section
    outs:
    - path: data/processed/chunks
      hash: md5
      md5: b3fd5b1369d991ccf8c917283af28719.dir
      size: 458580
      nfiles: 848
  naiverag_embed:
    cmd: uv run python src/app/naiverag/embed.py --input data/processed/chunks 
      --artifacts data/processed/extracted --database_url 
      postgresql://postgres:postgres@127.0.0.1:54322/postgres
    deps:
    - path: data/processed/chunks
      hash: md5
      md5: 97d328068fbd9307ce5e3db94b1beeb2.dir
      size: 159631484
      nfiles: 278692
    - path: data/processed/extracted
      hash: md5
      md5: 2b597a1b3021010b926d35600555ddc4.dir
      size: 27059869438
      nfiles: 12955
    - path: src/app/naiverag/embed.py
      hash: md5
      md5: d21b6d55f73e3d4d473473f060a76604
      size: 4213
  generate_queries:
    cmd: uv run open-rag-eval generate-queries --config query_gen_config.yaml
    deps:
    - path: data/processed/extracted
      hash: md5
      md5: 2fd66098f33b1fa4f54622de2ee7e74d.dir
      size: 131543751
      nfiles: 60
    - path: query_gen_config.yaml
      hash: md5
      md5: 0d8c0c18d51c68a7f3e3963582c87571
      size: 1356
    params:
      query_gen_config.yaml:
        generation.n_questions: 10
        generation.questions_per_doc: 10
        model.name: models/gemini-2.5-flash
        model.type: GeminiModel
    outs:
    - path: data/eval/queries.csv
      hash: md5
      md5: 66a94fb67a324565ef5eeba726740b08
      size: 1078
  graphmert_generate_answers:
    cmd: uv run python src/app/eval_open_rag.py --system graphmert --queries 
      data/eval/queries.csv --output data/eval/graphmert/generated_answers.csv
    deps:
    - path: data/eval/queries.csv
      hash: md5
      md5: 66a94fb67a324565ef5eeba726740b08
      size: 1078
    - path: data/processed/chunks
      hash: md5
      md5: b3fd5b1369d991ccf8c917283af28719.dir
      size: 458580
      nfiles: 848
    - path: src/app/eval_open_rag.py
      hash: md5
      md5: 61bd0758b057031d469089ce5910536a
      size: 20298
    - path: src/app/graphmert/corpus.py
      hash: md5
      md5: 165de504a23a3164d6440cf993123fda
      size: 1293
    - path: src/app/graphmert/inference.py
      hash: md5
      md5: cc5c00fd2f71f04ae9968d1f02e71697
      size: 7241
    - path: src/app/graphmert/train_model.py
      hash: md5
      md5: 514a2be1ab2d6f34b4e027fcf4214b50
      size: 6114
    - path: src/app/utils/params_helper.py
      hash: md5
      md5: 63ae89e1b9f548569371e1c50daa52b6
      size: 224
    params:
      params.yaml:
        eval.top_k: 5
    outs:
    - path: data/eval/graphmert/generated_answers.csv
      hash: md5
      md5: 15b189fa68273ab06a562f791d9867c0
      size: 57490
  naiverag_generate_answers:
    cmd: uv run python src/app/eval_open_rag.py --system naiverag --queries 
      data/eval/queries.csv --output data/eval/naiverag/generated_answers.csv
    deps:
    - path: data/eval/queries.csv
      hash: md5
      md5: 66a94fb67a324565ef5eeba726740b08
      size: 1078
    - path: data/processed/chunks
      hash: md5
      md5: b3fd5b1369d991ccf8c917283af28719.dir
      size: 458580
      nfiles: 848
    - path: src/app/embedder.py
      hash: md5
      md5: 67e5243b0780cf22eb5fa9d16f15c31d
      size: 4006
    - path: src/app/eval_open_rag.py
      hash: md5
      md5: 61bd0758b057031d469089ce5910536a
      size: 20298
    - path: src/app/utils/params_helper.py
      hash: md5
      md5: 63ae89e1b9f548569371e1c50daa52b6
      size: 224
    params:
      params.yaml:
        eval.top_k: 5
    outs:
    - path: data/eval/naiverag/generated_answers.csv
      hash: md5
      md5: 10cb01d3378c01f267641b3ddbe5ff4c
      size: 80679
  graphmert_eval:
    cmd: uv run open-rag-eval eval --config configs/open_rag_eval_graphmert.yaml
    deps:
    - path: configs/open_rag_eval_graphmert.yaml
      hash: md5
      md5: f244ad3639b2115b45fcdebeac6cdf76
      size: 740
    - path: data/eval/graphmert/generated_answers.csv
      hash: md5
      md5: 15b189fa68273ab06a562f791d9867c0
      size: 57490
    - path: data/eval/queries.csv
      hash: md5
      md5: 66a94fb67a324565ef5eeba726740b08
      size: 1078
    params:
      configs/open_rag_eval_graphmert.yaml:
        evaluator.0.model.name: gemini-2.5-flash
        evaluator.0.model.type: GeminiModel
        evaluator.0.options.k_values:
        - 1
        - 3
        - 5
    outs:
    - path: data/eval/graphmert/TRECEvaluator-metrics.png
      hash: md5
      md5: 9ff60589128ce8b2246da65e3c91cf8c
      size: 279100
    - path: data/eval/graphmert/results.csv
      hash: md5
      md5: 23a1374e944e46bf86c45ab2b35a0626
      size: 63240
  naiverag_eval:
    cmd: uv run open-rag-eval eval --config configs/open_rag_eval_naiverag.yaml
    deps:
    - path: configs/open_rag_eval_naiverag.yaml
      hash: md5
      md5: d0bfd76b931db77bb23aa50b066f17e2
      size: 758
    - path: data/eval/naiverag/generated_answers.csv
      hash: md5
      md5: 10cb01d3378c01f267641b3ddbe5ff4c
      size: 80679
    - path: data/eval/queries.csv
      hash: md5
      md5: 66a94fb67a324565ef5eeba726740b08
      size: 1078
    params:
      configs/open_rag_eval_naiverag.yaml:
        evaluator.0.model.name: gemini-2.5-flash
        evaluator.0.model.type: GeminiModel
        evaluator.0.options.k_values:
        - 1
        - 3
        - 5
    outs:
    - path: data/eval/naiverag/TRECEvaluator-metrics.png
      hash: md5
      md5: 2a0ec94c1b70c18e2b9178f92d9bf97e
      size: 280073
    - path: data/eval/naiverag/results.csv
      hash: md5
      md5: ea37c935bb027f5c079b7c915aa9efa4
      size: 88014
  linearrag_generate_answers:
    cmd: OLLAMA_BASE_URL=http://127.0.0.1:11434/v1 OLLAMA_MODEL=bge-m3:567m uv 
      run python src/app/eval_open_rag.py --system linearrag --queries 
      data/eval/queries.csv --output data/eval/linearrag/generated_answers.csv 
      --database_url postgresql://postgres:postgres@127.0.0.1:54322/postgres
    deps:
    - path: data/eval/queries.csv
      hash: md5
      md5: 66a94fb67a324565ef5eeba726740b08
      size: 1078
    - path: src/app/eval_open_rag.py
      hash: md5
      md5: 61bd0758b057031d469089ce5910536a
      size: 20298
    - path: src/app/linear_rag/retrieve.py
      hash: md5
      md5: 6ee9e1faaea7965b6659da0196456531
      size: 36798
    - path: src/app/utils/params_helper.py
      hash: md5
      md5: 63ae89e1b9f548569371e1c50daa52b6
      size: 224
    params:
      params.yaml:
        eval.top_k: 5
        generation.max_tokens: 30000
        index.embedding_provider: ollama
        index.spacy_model: en_core_sci_md
        retrieval.retrieval_top_k: 5
    outs:
    - path: data/eval/linearrag/generated_answers.csv
      hash: md5
      md5: fdff9a671873a97413a80ecf7151733a
      size: 126828
  linearrag_index:
    cmd: uv run python src/app/linear_rag/index.py --database_url 
      postgresql://postgres:postgres@127.0.0.1:54322/postgres
    deps:
    - path: src/app/linear_rag/index.py
      hash: md5
      md5: 61521e36b7df712ae2d2a28b25b79c62
      size: 17601
    params:
      params.yaml:
        index.batch_size: 32
        index.spacy_model: en_core_sci_md
  linearrag_load:
    cmd: uv run python src/app/linear_rag/load.py --input data/processed/chunks 
      --artifacts data/processed/extracted --database_url 
      postgresql://postgres:postgres@127.0.0.1:54322/postgres
    deps:
    - path: data/processed/chunks
      hash: md5
      md5: 97d328068fbd9307ce5e3db94b1beeb2.dir
      size: 159631484
      nfiles: 278692
    - path: data/processed/extracted
      hash: md5
      md5: 2b597a1b3021010b926d35600555ddc4.dir
      size: 27059869438
      nfiles: 12955
    - path: src/app/linear_rag/load.py
      hash: md5
      md5: 59d888a4a2df9a1f335496f4d9c54d68
      size: 6615
    params:
      params.yaml:
        load.batch_size: 100
  linearrag_eval:
    cmd: uv run open-rag-eval eval --config configs/open_rag_eval_linearrag.yaml
    deps:
    - path: configs/open_rag_eval_linearrag.yaml
      hash: md5
      md5: 0cd1a0ecdc01fc9218b5cc0638caa06c
      size: 760
    - path: data/eval/linearrag/generated_answers.csv
      hash: md5
      md5: fdff9a671873a97413a80ecf7151733a
      size: 126828
    - path: data/eval/queries.csv
      hash: md5
      md5: 66a94fb67a324565ef5eeba726740b08
      size: 1078
    params:
      configs/open_rag_eval_linearrag.yaml:
        evaluator.0.model.name: gemini-2.5-flash
        evaluator.0.model.type: GeminiModel
        evaluator.0.options.k_values:
        - 1
        - 3
        - 5
    outs:
    - path: data/eval/linearrag/TRECEvaluator-metrics.png
      hash: md5
      md5: 32c897e881e1b462ef2b4166149183bd
      size: 280327
    - path: data/eval/linearrag/results.csv
      hash: md5
      md5: 4dbcb10ed060651837ab5f3375f9c8df
      size: 136324
